`<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dependency Report</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15' stop-opacity='0.85'/%3E%3Cstop offset='100%25' stop-color='%231c1917'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%230f172a' stroke='%23facc15' stroke-width='3' opacity='0.95'/%3E%3Ccircle cx='18' cy='22' r='5' fill='%2338bdf8' opacity='0.85'/%3E%3Ccircle cx='46' cy='18' r='4' fill='%23f97316' opacity='0.75'/%3E%3Cpath d='M20 44 C 26 38 38 38 44 44' stroke='%2338bdf8' fill='none' stroke-width='3' stroke-linecap='round' opacity='0.8'/%3E%3Ctext x='15' y='38' font-family='JetBrains Mono,Menlo,monospace' font-size='18' font-weight='700' fill='%23facc15'%3ER%3C/text%3E%3Ctext x='35' y='38' font-family='JetBrains Mono,Menlo,monospace' font-size='18' font-weight='700' fill='%23facc15'%3ET%3C/text%3E%3C/svg%3E" />
<link rel="preconnect" href="https://fonts.cdnfonts.com">
<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/geist">
<link rel="stylesheet" href="https://fonts.cdnfonts.com/css/geist-mono">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<script>
  window.tailwind = window.tailwind || {};
  window.tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ["Geist", "Inter", "system-ui", "sans-serif"],
          mono: ["Geist Mono", "JetBrains Mono", "Menlo", "monospace"],
        },

      },
    },
  };
</script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  :root { color-scheme: dark; }
  body {
    font-family: 'Geist', sans-serif;
    position: relative;
    background:
      radial-gradient(120% 160% at 0% 0%, rgba(68, 64, 60, 0.65), transparent 55%),
      radial-gradient(120% 160% at 100% 0%, rgba(41, 37, 36, 0.55), transparent 55%),
      linear-gradient(180deg, #11100f 0%, #1c1917 100%);
    color: #e7e5e4;
  }
  html { scroll-behavior: smooth; }
  a.no-underline:hover { text-decoration: none !important; }
  .github-corner svg { fill: #151513; color: #ffffff; }
  .github-corner svg .octo-arm { transform-origin: 130px 106px; }
  .github-corner:hover .octo-arm { animation: octocat-wave 560ms ease-in-out; }
  .github-corner:focus-visible { outline: 2px solid rgba(244, 244, 245, 0.9); outline-offset: 4px; }
  @keyframes octocat-wave {
    0%, 100% { transform: rotate(0); }
    20%, 60% { transform: rotate(-18deg); }
    40%, 80% { transform: rotate(12deg); }
  }
</style>
</head>
<body class="min-h-screen bg-stone-950 antialiased text-stone-200">
  <a href="https://github.com/volnei/retracify" class="github-corner absolute right-0 top-0 z-50" aria-label="View source on GitHub" target="_blank" rel="noreferrer">
    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 250 250" fill="#151513" style="position: absolute; top: 0; right: 0">
    <path d="M0 0l115 115h15l12 27 108 108V0z" fill="#fff"/>
    <path class="octo-arm" d="M128 109c-15-9-9-19-9-19 3-7 2-11 2-11-1-7 3-2 3-2 4 5 2 11 2 11-3 10 5 15 9 16" style="-webkit-transform-origin: 130px 106px; transform-origin: 130px 106px"/>
    <path class="octo-body" d="M115 115s4 2 5 0l14-14c3-2 6-3 8-3-8-11-15-24 2-41 5-5 10-7 16-7 1-2 3-7 12-11 0 0 5 3 7 16 4 2 8 5 12 9s7 8 9 12c14 3 17 7 17 7-4 8-9 11-11 11 0 6-2 11-7 16-16 16-30 10-41 2 0 3-1 7-5 11l-12 11c-1 1 1 5 1 5z"/>
    </svg>
  </a>
  <header class="sticky top-0 z-40 border-b border-stone-900/70 bg-stone-950/95 backdrop-blur supports-[backdrop-filter]:bg-stone-950/80">
    <nav class="mx-auto flex w-full max-w-7xl items-center justify-between gap-6 px-4 py-4 text-sm text-stone-300 sm:px-6">
      <div class="flex items-center gap-3">
        <span class="inline-flex items-center gap-2 rounded-lg border border-stone-800/80 bg-stone-900/70 px-3 py-1 font-mono text-[11px] uppercase tracking-[0.26em] text-stone-200">
          Atlas Report
        </span>
        <ul class="hidden items-center gap-4 text-xs font-semibold uppercase tracking-[0.18em] text-stone-500 sm:flex">
          <li><a class="transition hover:text-stone-200" data-scroll-to="#overview" href="#overview">Overview</a></li>
          <li><a class="transition hover:text-stone-200" data-scroll-to="#insights" href="#insights">Cycles</a></li>
          <li><a class="transition hover:text-stone-200" data-scroll-to="#performance" href="#performance">Performance</a></li>
          <li><a class="transition hover:text-stone-200" data-scroll-to="#packages" href="#packages">Packages</a></li>
          <li><a class="transition hover:text-stone-200" data-scroll-to="#risk-guide" href="#risk-guide">Risk guide</a></li>
        </ul>
      </div>
      <a
        href="https://github.com/volnei/retracify"
        class="inline-flex items-center gap-2 rounded-full border border-stone-800/80 bg-stone-900/70 px-4 py-2 text-xs font-semibold uppercase tracking-[0.24em] text-stone-300 transition hover:border-stone-600 hover:text-stone-100"
        target="_blank"
        rel="noreferrer"
      >
        GitHub
      </a>
    </nav>
  </header>
  <main class="relative mx-auto flex w-full max-w-7xl flex-col gap-12 px-4 py-16 sm:gap-16 sm:px-6">
    <section class="rounded-xl border border-stone-900/75 bg-stone-950/85 p-6 shadow-[0_32px_80px_-60px_rgba(0,0,0,0.78)] sm:p-10">
      <%- include('partials/banner') %>
    </section>
    <section class="space-y-12" id="atlas-content">
      <div id="app-root" class="space-y-8">
        <div class="flex w-full justify-center py-16">
          <div class="flex flex-col items-center gap-3 text-sm text-stone-400">
            <div class="h-10 w-10 animate-spin rounded-full border-2 border-stone-800 border-t-transparent"></div>
            <p>Loading interactive overview...</p>
          </div>
        </div>
      </div>
      <%- include('partials/footer') %>
    </section>
  </main>
  <button id="scrollTop" type="button" aria-label="Scroll to top" class="fixed bottom-8 right-8 z-40 hidden h-12 w-12 items-center justify-center rounded-full border border-stone-900 bg-stone-950/80 text-stone-200 shadow-[0_20px_40px_-24px_rgba(0,0,0,0.7)] transition hover:-translate-y-1 hover:bg-stone-900 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-stone-400/80">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" x2="12" y1="19" y2="5"></line>
      <polyline points="5 12 12 5 19 12"></polyline>
    </svg>
  </button>
  <script>
    const starsBadge = document.getElementById("githubStars");
    if (starsBadge) {
      fetch("https://api.github.com/repos/volnei/retracify", { headers: { "Accept": "application/vnd.github+json" } })
        .then((response) => (response.ok ? response.json() : null))
        .then((data) => {
          if (!data || typeof data.stargazers_count !== "number") {
            throw new Error("No star data");
          }
          const count = data.stargazers_count;
          const formatted = count.toLocaleString();
          const starSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-amber-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 2.31 4.68L19.5 8.4l-3.66 3.57.86 5.03L12 14.77 7.3 17l.86-5.03L4.5 8.4l5.19-.72L12 3z"></path></svg>';
          starsBadge.innerHTML = starSvg +
            '<span>' + formatted + ' stars</span>';
        })
        .catch(() => {
          const starSvg = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-stone-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3 2.31 4.68L19.5 8.4l-3.66 3.57.86 5.03L12 14.77 7.3 17l.86-5.03L4.5 8.4l5.19-.72L12 3z"></path></svg>';
          starsBadge.innerHTML = starSvg +
            '<span>on GitHub</span>';
        });
    }

    const scrollTopBtn = document.getElementById("scrollTop");
    if (scrollTopBtn) {
      const toggleScrollTop = () => {
        scrollTopBtn.classList.toggle("hidden", window.scrollY < 320);
      };
      toggleScrollTop();
      window.addEventListener("scroll", toggleScrollTop, { passive: true });
      scrollTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }
  </script>
  <script id="reportData" type="application/json"><%- clientPayload %></script>
  <script type="module">
    import { h, render } from "https://esm.sh/preact@10.19.3";
    import { html } from "https://esm.sh/htm@3.1.1/preact";
    import { useEffect, useMemo, useRef, useState } from "https://esm.sh/preact@10.19.3/hooks";
    import {
      AlertTriangle,
      RefreshCw,
      Package as PackageIcon,
      Code2,
      Wrench,
      FileCode,
      GitBranch,
      ExternalLink,
      Users as UsersIcon,
      Check as CheckIcon,
      Clock,
      Search as SearchIcon,
      List as ListIcon,
      ShieldAlert,
      ShieldQuestion,
      ShieldCheck,
      Folder as FolderIcon,
      FileText,
      Copy as CopyIcon,
      Link2,
      X as XIcon,
    } from "https://esm.sh/lucide-preact@0.473.0";
    const cx = (...classes) => classes.filter(Boolean).join(" ");

    const isLiveMode = <%= liveMode ? "true" : "false" %>;
    if (isLiveMode) {
      window.__retracifyLiveMode = true;
    }

    const payloadEl = document.getElementById("reportData");
    const fallbackPayload = {
      summary: {
        packageCount: 0,
        dependencyCount: 0,
        cyclicDependencyCount: 0,
        cyclePackageCount: 0,
        undeclaredDependencyCount: 0,
        runtimeExternalCount: 0,
        toolingExternalCount: 0,
        typeExternalCount: 0,
        toolingDependencyCount: 0,
        packagesWithIssues: 0,
        averageDependencyCount: 0,
        averageToolingDeps: 0,
      },
      packages: [],
      insights: {
        cycles: {
          packageCount: 0,
          edgeCount: 0,
          edges: [],
        },
      },
      meta: {
        rootDir: "",
        generatedAt: "",
        nodeVersion: "",
        systemInfo: "",
      },
    };

    const KeySignals = ({ summary }) => {
      const signals = [
        {
          label: "Packages needing review",
          value: summary.packagesWithIssues ?? 0,
          helper: "Flagged by undeclared deps, cycles, or unused installs.",
          icon: Icon.alert,
        },
        {
          label: "Cycle participants",
          value: summary.cyclePackageCount ?? 0,
          helper: `${summary.cyclicDependencyCount ?? 0} cyclic edges detected.`,
          icon: Icon.cycle,
        },
        {
          label: "Missing declarations",
          value: summary.undeclaredDependencyCount ?? 0,
          helper: "Imports without manifest coverage.",
          icon: Icon.external,
        },
        {
          label: "Tooling-heavy packages",
          value: summary.toolingDependencyCount ?? 0,
          helper: "Configs & scripts that may slow setup.",
          icon: Icon.tool,
        },
      ];

      const tone = (value) =>
        value === 0
          ? "border-emerald-500/30 bg-emerald-900/20 text-emerald-100"
          : value < 3
            ? "border-amber-500/30 bg-amber-900/20 text-amber-100"
            : "border-rose-500/30 bg-rose-900/25 text-rose-100";

      return html`
        <section class="rounded-xl border border-stone-900/70 bg-stone-950/80 p-6">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p class="text-xs font-semibold uppercase tracking-wide text-stone-500">Key signals</p>
              <p class="text-sm text-stone-400">Start with the riskiest areas before diving into individual packages.</p>
            </div>
          </div>
          <div class="mt-4 grid gap-4 md:grid-cols-2">
            ${signals.map(
              (signal, index) => html`<article
                key=${index}
                class=${`rounded-xl border ${tone(signal.value)} p-4`}
              >
                <div class="flex items-center gap-3">
                  <span class="flex h-10 w-10 items-center justify-center rounded-lg bg-black/20">
                    ${signal.icon("h-4 w-4")}
                  </span>
                  <div>
                    <p class="text-[11px] font-semibold uppercase tracking-wide text-stone-200">${signal.label}</p>
                    <p class="text-2xl font-semibold text-stone-50">${signal.value}</p>
                  </div>
                </div>
                <p class="mt-3 text-xs text-stone-200/80">${signal.helper}</p>
              </article>`,
            )}
          </div>
        </section>
      `;
    };

    const mergePayload = (input = {}) => ({
      summary: {
        ...fallbackPayload.summary,
        ...((input && typeof input === "object" && input.summary) || {}),
      },
      packages: Array.isArray(input?.packages) ? input.packages : [],
      insights: {
        cycles: {
          ...fallbackPayload.insights.cycles,
          ...((input?.insights && input.insights.cycles) || {}),
          edges: Array.isArray(input?.insights?.cycles?.edges)
            ? input.insights.cycles.edges
            : fallbackPayload.insights.cycles.edges,
        },
      },
      meta: {
        ...fallbackPayload.meta,
        ...((input && typeof input === "object" && input.meta) || {}),
      },
    });

    const RiskGuide = () => {
      const scoringTiers = [
        {
          label: "High risk",
          description: "score ≥ 5 points",
          icon: Icon.severityHigh("h-4 w-4 text-rose-300"),
        },
        {
          label: "Needs review",
          description: "score 2‑4 points",
          icon: Icon.severityMedium("h-4 w-4 text-amber-300"),
        },
        {
          label: "Stable",
          description: "score < 2 points",
          icon: Icon.severityLow("h-4 w-4 text-emerald-300"),
        },
      ];
      const heuristics = [
        {
          icon: Icon.cycle("h-4 w-4 text-rose-300"),
          title: "Cyclic edges",
          detail: "Each package pair in a cycle adds +3 points.",
        },
        {
          icon: Icon.alert("h-4 w-4 text-amber-300"),
          title: "Undeclared internals",
          detail: "+2 points per missing workspace dependency (up to +4).",
        },
        {
          icon: Icon.external("h-4 w-4 text-amber-200"),
          title: "Undeclared externals",
          detail: "+2 points per missing external package (up to +4).",
        },
        {
          icon: Icon.check("h-4 w-4 text-emerald-300"),
          title: "Unused externals",
          detail: "+1 point for each unused external dependency (up to +3).",
        },
        {
          icon: Icon.external("h-4 w-4 text-sky-300"),
          title: "High runtime footprint",
          detail: "+1 point if more than 12 runtime externals are present.",
        },
        {
          icon: Icon.dependency("h-4 w-4 text-stone-200"),
          title: "Large internal surface",
          detail: "+1 point when a package depends on over 15 workspace modules.",
        },
      ];
      return html`
        <section class="rounded-lg border border-stone-900/70 bg-stone-950/75 p-6 shadow-[0_14px_40px_-32px_rgba(0,0,0,0.7)]">
          <div class="space-y-2">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-stone-400">Risk heuristics</h3>
            <p class="text-sm text-stone-500">
              Retracify derives a severity score by adding points for the signals below. Thresholds determine
              whether a package is marked stable, needs review, or high risk.
            </p>
          </div>
          <div class="mt-4 grid gap-3 md:grid-cols-2">
            ${heuristics.map(
              (item) => html`<article key=${item.title} class="flex items-start gap-3 rounded-md border border-stone-900/70 bg-stone-950/60 px-4 py-3">
                <span class="flex h-9 w-9 items-center justify-center rounded-md bg-stone-900/50 text-stone-200">
                  ${item.icon}
                </span>
                <div class="space-y-1">
                  <p class="text-xs font-semibold uppercase tracking-wide text-stone-200">${item.title}</p>
                  <p class="text-xs text-stone-400">${item.detail}</p>
                </div>
              </article>`,
            )}
          </div>
          <div class="mt-5 flex flex-wrap items-center gap-3 text-xs text-stone-400">
            ${scoringTiers.map(
              (tier) => html`<span key=${tier.label} class="inline-flex items-center gap-2 rounded-full border border-stone-900/70 bg-stone-950/60 px-3 py-1">
                ${tier.icon}
                <span class="font-semibold text-stone-200">${tier.label}</span>
                <span class="text-stone-400">${tier.description}</span>
              </span>`,
            )}
          </div>
        </section>
      `;
    };

    let rawPayload = payloadEl?.textContent || "{}";
    let parsedPayload = fallbackPayload;
    if (payloadEl) {
      try {
        parsedPayload = JSON.parse(rawPayload || "{}") || fallbackPayload;
      } catch (error) {
        console.error("Failed to parse report payload", error);
      }
    }

    const liveModeActive = Boolean(window.__retracifyLiveMode);
    let liveStatus = liveModeActive
      ? { message: "Preparing workspace…" }
      : null;
    let payload = mergePayload(parsedPayload);

    const Icon = {
      cycle: (className = "h-4 w-4") => html`<${RefreshCw} class=${className} strokeWidth=${1} />`,
      alert: (className = "h-4 w-4") =>
        html`<${AlertTriangle} class=${className} strokeWidth=${1} />`,
      package: (className = "h-4 w-4") =>
        html`<${PackageIcon} class=${className} strokeWidth=${1} />`,
      dev: (className = "h-4 w-4") => html`<${Code2} class=${className} strokeWidth=${1} />`,
      tool: (className = "h-4 w-4") => html`<${Wrench} class=${className} strokeWidth=${1} />`,
      type: (className = "h-4 w-4") => html`<${FileCode} class=${className} strokeWidth=${1} />`,
      dependency: (className = "h-4 w-4") =>
        html`<${GitBranch} class=${className} strokeWidth=${1} />`,
      external: (className = "h-4 w-4") =>
        html`<${ExternalLink} class=${className} strokeWidth=${1} />`,
      users: (className = "h-4 w-4") =>
        html`<${UsersIcon} class=${className} strokeWidth=${1} />`,
      check: (className = "h-4 w-4") => html`<${CheckIcon} class=${className} strokeWidth=${1} />`,
      clock: (className = "h-4 w-4") => html`<${Clock} class=${className} strokeWidth=${1} />`,
      search: (className = "h-4 w-4") => html`<${SearchIcon} class=${className} strokeWidth=${1} />`,
      list: (className = "h-4 w-4") => html`<${ListIcon} class=${className} strokeWidth=${1} />`,
      severityHigh: (className = "h-4 w-4") =>
        html`<${ShieldAlert} class=${className} strokeWidth=${1} />`,
      severityMedium: (className = "h-4 w-4") =>
        html`<${ShieldQuestion} class=${className} strokeWidth=${1} />`,
      severityLow: (className = "h-4 w-4") =>
        html`<${ShieldCheck} class=${className} strokeWidth=${1} />`,
      folder: (className = "h-4 w-4") => html`<${FolderIcon} class=${className} strokeWidth=${1} />`,
      file: (className = "h-4 w-4") => html`<${FileText} class=${className} strokeWidth=${1} />`,
      copy: (className = "h-4 w-4") => html`<${CopyIcon} class=${className} strokeWidth=${1} />`,
      link: (className = "h-4 w-4") => html`<${Link2} class=${className} strokeWidth=${1} />`,
      x: (className = "h-4 w-4") => html`<${XIcon} class=${className} strokeWidth=${1} />`,
    };

    const Legend = () => {
      const entries = [
        {
          icon: Icon.cycle("h-4 w-4 text-rose-300"),
          bg: "bg-rose-900/40",
          title: "Circular dependency",
          description: "Edges that complete cycles between packages.",
        },
        {
          icon: Icon.alert("h-4 w-4 text-amber-300"),
          bg: "bg-amber-900/30",
          title: "Undeclared usage",
          description: "Imports missing from package manifests.",
        },
        {
          icon: Icon.package("h-4 w-4 text-emerald-200"),
          bg: "bg-emerald-900/30",
          title: "Declared dependency",
          description: "Runtime dependency tracked in workspace manifests.",
        },
        {
          icon: Icon.dev("h-4 w-4 text-sky-200"),
          bg: "bg-sky-900/35",
          title: "Dev-only dependency",
          description: "Declared only under devDependencies.",
        },
        {
          icon: Icon.tool("h-4 w-4 text-stone-200"),
          bg: "bg-stone-900",
          title: "Tooling dependency",
          description: "Detected via configs or package scripts.",
        },
        {
          icon: Icon.type("h-4 w-4 text-purple-200"),
          bg: "bg-purple-900/30",
          title: "Type-only dependency",
          description: "Type packages without runtime usage.",
        },
      ];

      return html`
        <section class="rounded-xl border border-stone-900/70 bg-stone-950/80 p-5">
          <h2 class="text-xs font-semibold uppercase tracking-[0.26em] text-stone-500">Legend</h2>
          <div class="mt-4 space-y-3">
            ${entries.map(
              (entry, idx) => html`<article
                key=${idx}
                class="flex items-start gap-3 rounded-lg border border-stone-900/70 bg-stone-950/60 px-4 py-3"
              >
                <span class=${`flex h-9 w-9 items-center justify-center rounded-md ${entry.bg}`}>${entry.icon}</span>
                <div class="space-y-1">
                  <p class="text-xs font-semibold uppercase tracking-wide text-stone-200">${entry.title}</p>
                  <p class="text-xs text-stone-400">${entry.description}</p>
                </div>
              </article>`,
            )}
          </div>
        </section>
      `;
    };

    const derivePerformanceInsights = (packages) => {
      const makeEntry = (pkg) => ({
        name: pkg.displayName,
        anchor: pkg.anchorId,
        severity: pkg.severityLevel,
      });

      const heavyFanout = packages
        .map((pkg) => ({
          ...makeEntry(pkg),
          deps: pkg.dependencies.length,
          externals: pkg.runtimeExternalCount ?? 0,
          tooling: pkg.toolingDepsList.length,
          score:
            pkg.dependencies.length * 1.3 +
            (pkg.runtimeExternalCount ?? 0) * 1.8 +
            pkg.toolingDepsList.length * 0.8,
        }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 5);

      const externalHubs = packages
        .map((pkg) => ({
          ...makeEntry(pkg),
          externals: pkg.externalDependencyBadges.length,
          undeclared: pkg.undeclaredExternalCount ?? 0,
        }))
        .sort((a, b) => b.externals - a.externals)
        .slice(0, 5);

      const toolingSurface = packages
        .map((pkg) => ({
          ...makeEntry(pkg),
          tooling: pkg.toolingDepsList.length,
        }))
        .sort((a, b) => b.tooling - a.tooling)
        .slice(0, 5);

      return { heavyFanout, externalHubs, toolingSurface };
    };

    const LiveStatusToast = ({ status }) => {
      const [visible, setVisible] = useState(status ? { ...status } : null);

      useEffect(() => {
        if (!status) {
          setVisible(null);
          return;
        }
        const next = { ...status };
        setVisible(next);
        if (typeof status.progress === "number") {
          return;
        }
        const timer = window.setTimeout(() => {
          setVisible((current) =>
            current && current.message === next.message ? null : current,
          );
        }, 4000);
        return () => window.clearTimeout(timer);
      }, [status?.message, status?.progress]);

      if (!visible) return null;
      const isProgress = typeof visible.progress === "number";
      const isFailure =
        typeof visible.message === "string" &&
        visible.message.toLowerCase().startsWith("failed");
      const tone = isFailure
        ? "border-rose-600/60 bg-rose-950/80 text-rose-100"
        : isProgress
          ? "border-sky-500/60 bg-sky-950/80 text-sky-100"
          : "border-emerald-500/60 bg-emerald-950/80 text-emerald-100";
      const icon = isFailure
        ? Icon.alert("h-3.5 w-3.5")
        : isProgress
          ? Icon.cycle("h-3.5 w-3.5 animate-spin")
          : Icon.check("h-3.5 w-3.5");

      return html`
        <div
          class=${`pointer-events-none fixed left-1/2 top-6 z-50 flex -translate-x-1/2 items-center gap-3 rounded-full border px-4 py-2 text-xs font-semibold uppercase tracking-wide shadow-[0_20px_45px_-30px_rgba(0,0,0,0.85)] ${tone}`}
        >
          <span class="flex items-center gap-2">
            ${icon}
            <span>${visible.message}</span>
          </span>
          ${isProgress
            ? html`<span class="font-mono text-xs">${Math.round(visible.progress)}%</span>`
            : null}
        </div>
      `;
    };

    const PerformancePanel = ({ data }) => {
      if (!data) return null;
      const renderList = (title, description, items, metricLabel, icon) => html`
        <article class="space-y-3 rounded-xl border border-stone-900/60 bg-stone-950/65 p-4">
          <header class="space-y-1">
            <p class="flex items-center gap-2 text-xs font-semibold uppercase tracking-wide text-stone-400">
              ${icon}
              ${title}
            </p>
            <p class="text-xs text-stone-500">${description}</p>
          </header>
          <ol class="space-y-2 text-sm text-stone-300">
            ${items.length
              ? items.map((item, index) => html`<li
                  key=${item.anchor}
                  class="flex items-center justify-between gap-3 rounded-lg border border-stone-900/60 bg-stone-950/60 px-3 py-2"
                >
                  <div class="flex items-center gap-3">
                    <span class="text-xs font-mono text-stone-500">${index + 1}</span>
                    <a class="text-sm font-semibold text-stone-100 underline-offset-4 transition hover:text-stone-50 hover:underline" href=${`#${item.anchor}`}>
                      ${item.name}
                    </a>
                    ${item.severity === "critical"
                      ? html`<span class="inline-flex items-center gap-1 rounded-full bg-rose-500/15 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-rose-200">
                          ${Icon.severityHigh("h-3 w-3")}
                          High risk
                        </span>`
                      : null}
                  </div>
                  <span class="font-mono text-xs text-stone-400">${metricLabel(item)}</span>
                </li>`)
              : html`<li class="rounded-lg border border-stone-900/60 bg-stone-950/60 px-3 py-2 text-xs text-stone-500">
                  No signals detected.
                </li>`}
          </ol>
        </article>`;

      const copyDiagnostics = () => {
        const script = `pnpm tsc --extendedDiagnostics > .retracify/tsc-metrics.log`;
        if (navigator?.clipboard?.writeText) {
          navigator.clipboard.writeText(script).catch(() => {
            window.prompt("Copy command", script);
          });
        } else {
          window.prompt("Copy command", script);
        }
      };

      return html`
        <section class="space-y-6 rounded-xl border border-stone-900/70 bg-stone-950/75 p-6">
          <header class="space-y-2">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-stone-400">Performance outlook</h3>
            <p class="text-sm text-stone-500">
              Use these heuristics to anticipate slow rebuilds. Pair them with compiler diagnostics to confirm
              which files are truly expensive.
            </p>
          </header>
          <div class="grid gap-4 lg:grid-cols-2 xl:grid-cols-3">
            ${renderList(
              "High fan-out modules",
              "Large dependency footprints often slow incremental builds.",
              data.heavyFanout,
              (item) => `${item.deps} deps · ${item.externals} externals · ${item.tooling} tooling`,
              Icon.dependency("h-4 w-4 text-sky-200"),
            )}
            ${renderList(
              "External hubs",
              "Modules importing many packages are prime candidates for code-splitting.",
              data.externalHubs,
              (item) => `${item.externals} externals${item.undeclared ? ` · ${item.undeclared} missing` : ""}`,
              Icon.external("h-4 w-4 text-amber-200"),
            )}
            ${renderList(
              "Tooling weight",
              "Heavy tooling footprints often correlate with longer dev server boot times.",
              data.toolingSurface,
              (item) => `${item.tooling} tooling deps`,
              Icon.tool("h-4 w-4 text-emerald-200"),
            )}
          </div>
          <div class="rounded-xl border border-stone-900/70 bg-stone-950/60 p-4 text-sm text-stone-300">
            <div class="flex flex-wrap items-center justify-between gap-3">
              <div class="space-y-1">
                <p class="text-xs font-semibold uppercase tracking-wide text-stone-500">Capture real diagnostics</p>
                <p class="text-xs text-stone-400">
                  Run <code>tsc --extendedDiagnostics</code> or <code>babel --profile</code> in CI, publish the JSON next to your atlas, and Retracify can ingest the results on the next scan.
                </p>
              </div>
              <button
                type="button"
                onClick=${copyDiagnostics}
                class="inline-flex items-center gap-2 rounded-full border border-stone-800/70 bg-stone-900/70 px-3 py-1.5 text-xs font-semibold uppercase tracking-wide text-stone-200 transition hover:border-stone-600 hover:text-stone-100"
              >
                ${Icon.copy("h-3 w-3")}
                Copy TS diagnostics command
              </button>
            </div>
          </div>
        </section>
      `;
    };

    document.querySelectorAll("[data-icon]").forEach((placeholder) => {
      const iconKey = placeholder.getAttribute("data-icon");
      const renderIcon = iconKey ? Icon[iconKey] : null;
      if (typeof renderIcon === "function") {
        const iconClass = placeholder.getAttribute("data-icon-class") || "h-5 w-5";
        render(renderIcon(iconClass), placeholder);
      }
    });
    const SummaryCards = ({ summary, meta }) => {
      const statCards = [
        {
          icon: Icon.package("h-4 w-4 text-emerald-200"),
          label: "Packages",
          value: summary.packageCount ?? 0,
          helper: `${summary.packagesWithIssues ?? 0} flagged`,
        },
        {
          icon: Icon.dependency("h-4 w-4 text-sky-200"),
          label: "Graph edges",
          value: summary.dependencyCount ?? 0,
          helper: `Avg ${summary.averageDependencyCount ?? 0} per package`,
        },
        {
          icon: Icon.external("h-4 w-4 text-amber-200"),
          label: "Runtime externals",
          value: summary.runtimeExternalCount ?? 0,
          helper: `${summary.typeExternalCount ?? 0} type · ${summary.toolingExternalCount ?? 0} tooling`,
        },
        {
          icon: Icon.tool("h-4 w-4 text-purple-200"),
          label: "Tooling surface",
          value: summary.toolingDependencyCount ?? 0,
          helper: `Avg ${summary.averageToolingDeps ?? 0} configs/scripts`,
        },
      ];

      const metaItems = [
        { label: "Root directory", value: meta.rootDir || "—" },
        { label: "Generated", value: meta.generatedAt || "—" },
        { label: "Node runtime", value: meta.nodeVersion || "—" },
        { label: "System", value: meta.systemInfo || "local" },
      ];

      return html`
        <section class="space-y-6 rounded-xl border border-stone-900/70 bg-stone-950/80 p-6">
          <header class="space-y-1">
            <p class="text-xs font-semibold uppercase tracking-wide text-stone-500">Atlas snapshot</p>
            <p class="text-sm text-stone-400">
              ${meta.rootDir || "—"} · Generated ${meta.generatedAt || "—"} · Node ${meta.nodeVersion || "—"}
            </p>
          </header>
          <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
            ${statCards.map(
              (card, index) => html`<article
                key=${index}
                class="rounded-xl border border-stone-900/70 bg-stone-950/65 p-4 shadow-[0_18px_30px_-32px_rgba(0,0,0,0.8)]"
              >
                <div class="flex items-center justify-between gap-3">
                  <span class="flex h-10 w-10 items-center justify-center rounded-lg bg-stone-900/60">${card.icon}</span>
                  <span class="text-[11px] font-semibold uppercase tracking-wide text-stone-500">${card.label}</span>
                </div>
                <p class="mt-4 text-2xl font-semibold text-stone-100">${card.value}</p>
                <p class="mt-1 text-xs text-stone-400">${card.helper}</p>
              </article>`,
            )}
          </div>
          <dl class="grid gap-3 sm:grid-cols-2">
            ${metaItems.map(
              ({ label, value }) => html`<div class="rounded-lg border border-stone-900/70 bg-stone-950/65 p-3 text-xs">
                <dt class="font-semibold uppercase tracking-wide text-stone-500">${label}</dt>
                <dd class="mt-1 truncate text-stone-200" title=${value}>${value}</dd>
              </div>`,
            )}
          </dl>
        </section>
      `;
    };

    const filterOptions = [
      {
        id: "all",
        label: "All packages",
        icon: Icon.package,
      },
      {
        id: "issues",
        label: "Needs attention",
        icon: Icon.alert,
      },
      {
        id: "critical",
        label: "High risk",
        icon: Icon.severityHigh,
      },
      {
        id: "tooling",
        label: "Has tooling",
        icon: Icon.tool,
      },
    ];

    const FilterBar = ({ filter, setFilter, search, setSearch, counts }) => html`
      <div class="flex flex-col gap-4 rounded-lg border border-stone-900/70 bg-stone-950/80 p-4 sm:p-5">
        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
          ${filterOptions.map(({ id, label, icon }) => {
            const isActive = filter === id;
            return html`
              <button
                key=${id}
                type="button"
                class=${cx(
                  "flex w-full items-center gap-3 rounded-md border px-4 py-3 text-left transition focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-stone-400/70",
                  isActive
                    ? "border-stone-500/80 bg-stone-900/70 text-stone-100 shadow-[inset_0_0_0_1px_rgba(255,255,255,0.05)]"
                    : "border-stone-900 text-stone-400 hover:border-stone-600 hover:text-stone-100",
                )}
                onClick=${() => setFilter(id)}
              >
                <span class="flex h-9 w-9 items-center justify-center rounded-md bg-stone-900/60 text-stone-200">
                  ${icon("h-4 w-4")}
                </span>
                <span class="flex flex-col">
                  <span class="text-sm font-semibold">${label}</span>
                  <span class="text-[11px] text-stone-500">${counts[id] ?? 0} matches</span>
                </span>
              </button>`;
          })}
        </div>
        <label class="flex w-full items-center gap-3 rounded-full border border-stone-900/70 bg-stone-950/70 px-4 py-2 text-xs text-stone-400 focus-within:border-stone-600">
          <span>${Icon.search("h-4 w-4 text-stone-500")}</span>
          <input
            class="flex-1 bg-transparent text-sm text-stone-200 placeholder:text-stone-500 outline-none"
            placeholder="Search packages"
            value=${search}
            onInput=${(event) => setSearch(event.currentTarget.value)}
          />
          ${search
            ? html`<button
                type="button"
                class="text-stone-500 transition hover:text-stone-200"
                onClick=${() => setSearch("")}
                aria-label="Clear search"
              >
                ${Icon.x("h-4 w-4")}
              </button>`
            : null}
        </label>
      </div>
    `;

    const CycleInsights = ({ summary, insights }) => {
      const edges = Array.isArray(insights?.edges) ? insights.edges : [];
      const edgeCount = insights?.edgeCount ?? 0;
      const packageCount = insights?.packageCount ?? 0;

      if (!edges.length) {
        return html`
          <section class="rounded-lg border border-stone-900/70 bg-stone-950/80 p-6 shadow-[0_12px_40px_-32px_rgba(0,0,0,0.7)]">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h3 class="text-lg font-semibold text-stone-100">Circular dependency insights</h3>
                <p class="text-sm text-stone-400">No circular dependencies detected in this snapshot.</p>
              </div>
              <span class="inline-flex items-center gap-2 rounded-full border border-emerald-500/40 bg-emerald-900/30 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-emerald-200">
                <span class="flex h-6 w-6 items-center justify-center rounded-full bg-emerald-900/40">
                  ${Icon.check("h-3.5 w-3.5")}
                </span>
                Clean graph
              </span>
            </div>
          </section>
        `;
      }

      const severityMeta = {
        high: {
          tone: "border border-rose-600/40 bg-rose-950/30 text-rose-200",
          badge: "border-rose-500/50 bg-rose-900/40 text-rose-200",
          icon: Icon.severityHigh,
          label: "High impact",
        },
        medium: {
          tone: "border border-amber-500/35 bg-amber-950/30 text-amber-200",
          badge: "border-amber-500/45 bg-amber-900/35 text-amber-200",
          icon: Icon.severityMedium,
          label: "Moderate",
        },
        low: {
          tone: "border border-sky-500/35 bg-sky-950/30 text-sky-200",
          badge: "border-sky-500/45 bg-sky-900/35 text-sky-200",
          icon: Icon.severityLow,
          label: "Low",
        },
      };

      const topEdges = edges.slice(0, 6);
      const remaining = edges.length - topEdges.length;

      return html`
        <section class="space-y-5 rounded-lg border border-stone-900/70 bg-stone-950/80 p-6 shadow-[0_12px_40px_-32px_rgba(0,0,0,0.7)]">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
            <div class="space-y-1">
              <h3 class="text-lg font-semibold text-stone-100">Circular dependency insights</h3>
              <p class="text-sm text-stone-400">
                Investigate the packages participating in cycles and plan remediation.
              </p>
            </div>
            <div class="grid gap-2 text-right text-xs text-stone-400 sm:grid-cols-3">
              <div class="rounded-md border border-stone-900/70 bg-stone-950/70 px-3 py-2 font-mono uppercase tracking-[0.24em] text-stone-300">
                ${edgeCount}<span class="ml-2 text-[11px] text-stone-500 normal-case tracking-normal">pairs</span>
              </div>
              <div class="rounded-md border border-stone-900/70 bg-stone-950/70 px-3 py-2 font-mono uppercase tracking-[0.24em] text-stone-300">
                ${packageCount}<span class="ml-2 text-[11px] text-stone-500 normal-case tracking-normal">packages</span>
              </div>
              <div class="rounded-md border border-stone-900/70 bg-stone-950/70 px-3 py-2 font-mono uppercase tracking-[0.24em] text-stone-300">
                ${summary.cyclicDependencyCount ?? 0}<span class="ml-2 text-[11px] text-stone-500 normal-case tracking-normal">edges</span>
              </div>
            </div>
          </div>
          <div class="grid gap-4 md:grid-cols-2">
            ${topEdges.map((edge, index) => {
              const meta = severityMeta[edge.severity] ?? severityMeta.medium;
              return html`
                <article
                  key=${index}
                  class=${cx("space-y-3 rounded-lg px-4 py-4 transition-shadow hover:shadow-[0_18px_30px_-28px_rgba(0,0,0,0.8)]", meta.tone)}
                >
                  <div class="flex flex-wrap items-start justify-between gap-3">
                    <div class="space-y-1">
                      <div class="flex flex-wrap items-center gap-2 text-sm font-semibold">
                        <a href=${`#${edge.fromAnchor}`} class="underline-offset-4 transition hover:underline">
                          ${edge.fromName}
                        </a>
                      <span class="flex h-6 w-6 items-center justify-center rounded-full bg-stone-900/40 text-stone-300">
                          ${Icon.link("h-3 w-3")}
                        </span>
                        <a href=${`#${edge.toAnchor}`} class="underline-offset-4 transition hover:underline">
                          ${edge.toName}
                        </a>
                      </div>
                      <p class="text-xs text-stone-300">
                        ${edge.referenceFileCount} referenced files · ${edge.edgeCount} edges observed
                      </p>
                    </div>
                      <span
                        class=${cx(
                          "inline-flex items-center gap-2 rounded-full px-2.5 py-1 text-[11px] font-semibold uppercase tracking-wide",
                          meta.badge,
                        )}
                        title=${meta.label}
                    >
                      <span class="flex h-6 w-6 items-center justify-center rounded-full bg-black/20">
                        ${meta.icon("h-3.5 w-3.5")}
                      </span>
                      ${meta.label}
                    </span>
                  </div>
                  ${edge.sampleFiles?.length
                    ? html`<div class="space-y-1.5">
                        <p class="text-[11px] font-semibold uppercase tracking-wide text-stone-300">
                          Sample paths
                        </p>
                        <ul class="space-y-1 text-[11px] text-stone-300">
                          ${edge.sampleFiles.map(
                            (entry, fileIndex) => html`<li
                              key=${fileIndex}
                              class="flex flex-wrap items-center gap-2 rounded border border-stone-800/70 bg-stone-950/60 px-2 py-1"
                            >
                              <a
                                class="font-medium text-stone-200 underline-offset-4 transition hover:underline"
                                href=${`#${entry.ownerAnchor}`}
                              >
                                ${entry.ownerName}
                              </a>
                              <span class="text-stone-500">·</span>
                              <code class="truncate font-mono text-stone-400">${entry.file}</code>
                            </li>`,
                          )}
                        </ul>
                      </div>`
                    : null}
                </article>
              `;
            })}
          </div>
          ${remaining > 0
            ? html`<p class="text-xs text-stone-500">
                +${remaining} additional cycle pair${remaining === 1 ? "" : "s"} recorded in this snapshot.
              </p>`
            : null}
        </section>
      `;
    };

    const DependencyDrilldown = ({ items, defaultExpanded = false }) => {
      const [copiedPath, setCopiedPath] = useState("");
      const copyTimerRef = useRef(null);

      if (!items || items.length === 0) return null;

      const resolveEditorLinks = (filePath) => {
        if (typeof filePath !== "string" || filePath.length === 0) {
          return null;
        }
        const rootDir =
          typeof payload.meta?.rootDir === "string" ? payload.meta.rootDir : "";
        const normalize = (value) => value.replace(/\\/g, "/");
        const normalizedRoot = rootDir ? normalize(rootDir) : "";
        const normalizedFile = normalize(filePath);
        const hasDrive = /^[A-Za-z]:/i.test(normalizedFile);
        const isAbsolute =
          normalizedFile.startsWith("/") || hasDrive;
        if (!isAbsolute && !normalizedRoot) {
          return null;
        }
        const basePath = isAbsolute
          ? normalizedFile
          : normalizedRoot
            ? `${normalizedRoot.replace(/\/$/, "")}/${normalizedFile.replace(/^\.?\//, "")}`
            : normalizedFile;
        const encodedPath = encodeURIComponent(basePath);
        return {
          vscode: `vscode://file/${encodedPath}`,
          zed: `zed://open?path=${encodedPath}`,
        };
      };

      const handleCopy = async (filePath) => {
        try {
          if (typeof navigator !== "undefined" && navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(filePath);
          } else {
            window.prompt("Copy path", filePath);
          }
          if (copyTimerRef.current) {
            clearTimeout(copyTimerRef.current);
          }
          setCopiedPath(filePath);
          copyTimerRef.current = window.setTimeout(() => {
            setCopiedPath("");
            copyTimerRef.current = null;
          }, 1600);
        } catch (error) {
          window.prompt("Copy path", filePath);
        }
      };

      const totalFiles = items.reduce((acc, item) => acc + item.fileCount, 0);

      return html`
        <details
          class="group mt-4 rounded-lg border border-stone-900/70 bg-stone-950/70 p-4"
          open=${defaultExpanded}
        >
          <summary class="flex cursor-pointer items-center justify-between text-xs font-semibold uppercase tracking-wide text-stone-300">
            <span class="flex items-center gap-2">
              <span class="flex h-7 w-7 items-center justify-center rounded-md bg-stone-900/60 text-stone-300">
                ${Icon.folder("h-4 w-4")}
              </span>
              Dependency file map
            </span>
            <span class="text-[11px] text-stone-500">${totalFiles} file${totalFiles === 1 ? "" : "s"}</span>
          </summary>
          <div class="mt-4 space-y-4">
            ${items.map(
              (item) => html`
                <div key=${item.name} class="space-y-2 rounded-md border border-stone-900/70 bg-stone-950/60 p-3">
                  <div class="flex items-center justify-between gap-3">
                    <span class="font-mono text-xs text-stone-300">${item.name}</span>
                    <span class="text-[11px] text-stone-500">${item.fileCount} file${item.fileCount === 1 ? "" : "s"}</span>
                  </div>
                  <div class="space-y-1.5">
                    ${item.files.map(
                      (file) => html`
                        <div
                          key=${file}
                          class="flex flex-wrap items-center gap-2 rounded border border-stone-900/60 bg-stone-950/70 px-2 py-1"
                        >
                          <code class="flex-1 truncate font-mono text-[11px] text-stone-300" title=${file}>${file}</code>
                          <div class="flex items-center gap-1.5">
                            ${(() => {
                              const links = resolveEditorLinks(file);
                              if (!links) return null;
                              return html`
                                <a
                                  class="inline-flex items-center gap-1 rounded border border-stone-900/60 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-stone-300 transition hover:border-stone-700 hover:text-stone-100"
                                  href=${links.vscode}
                                  target="_blank"
                                  rel="noreferrer"
                                >
                                  ${Icon.link("h-3.5 w-3.5")}
                                  VS Code
                                </a>
                                <a
                                  class="inline-flex items-center gap-1 rounded border border-stone-900/60 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-stone-300 transition hover:border-stone-700 hover:text-stone-100"
                                  href=${links.zed}
                                  target="_blank"
                                  rel="noreferrer"
                                >
                                  ${Icon.link("h-3.5 w-3.5")}
                                  Zed
                                </a>
                              `;
                            })()}
                            <button
                              type="button"
                              class="inline-flex items-center gap-1 rounded border border-stone-900/60 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-stone-300 transition hover:border-stone-700 hover:text-stone-100"
                              onClick=${() => handleCopy(file)}
                            >
                              ${copiedPath === file ? Icon.check("h-3 w-3") : Icon.copy("h-3 w-3")}
                              ${copiedPath === file ? "Copied" : "Copy"}
                            </button>
                          </div>
                        </div>
                      `,
                    )}
                  </div>
                </div>
              `,
            )}
          </div>
        </details>
      `;
    };

    const severityStyles = {
      critical: {
        badge: "border-rose-600/50 bg-rose-950/35 text-rose-200",
        chip: "border-rose-600/45 bg-rose-950/25 text-rose-200",
        icon: Icon.severityHigh,
      },
      watch: {
        badge: "border-amber-500/45 bg-amber-950/30 text-amber-200",
        chip: "border-amber-500/40 bg-amber-950/25 text-amber-200",
        icon: Icon.severityMedium,
      },
      stable: {
        badge: "border-emerald-500/45 bg-emerald-950/30 text-emerald-200",
        chip: "border-emerald-500/40 bg-emerald-950/25 text-emerald-200",
        icon: Icon.severityLow,
      },
    };

    const DependencyBadge = ({ dep }) => {
      const isDevOnly = Boolean(dep.isDevOnly);
      const tone = dep.isUndeclared
        ? "border-amber-500/45 bg-amber-950/30 text-amber-200 hover:border-amber-400/60"
        : dep.isCyclic
          ? "border-rose-600/45 bg-rose-950/35 text-rose-200 hover:border-rose-500/60"
          : isDevOnly
            ? "border-sky-500/45 bg-sky-950/30 text-sky-200 hover:border-sky-400/60"
            : "border-stone-900/70 bg-stone-950/60 text-stone-200 hover:border-stone-700";
      const glyphs = [isDevOnly ? Icon.dev("h-3 w-3") : Icon.package("h-3 w-3")];
      if (dep.isCyclic) glyphs.push(Icon.cycle("h-3 w-3"));
      if (dep.isUndeclared) glyphs.push(Icon.alert("h-3 w-3"));
      return html`
        <a
          href=${`#${dep.anchor}`}
          class=${`inline-flex items-center gap-2 rounded-md border px-3 py-1 text-xs font-medium transition ${tone}`}
        >
          <span class="flex items-center gap-1 text-current">
            ${glyphs.map(
              (icon, index) =>
                html`<span key=${index} class="inline-flex items-center justify-center">${icon}</span>`,
            )}
          </span>
          <span class="font-mono text-[11px]">${dep.name}</span>
        </a>
      `;
    };

    const ExternalBadge = ({ dep }) => {
      const tone = !dep.isDeclared
        ? "border-amber-500/45 bg-amber-950/30 text-amber-200 hover:border-amber-400/60"
        : dep.isToolingOnly || dep.isDevOnly
          ? "border-sky-500/45 bg-sky-950/30 text-sky-200 hover:border-sky-400/60"
        : dep.isTypeOnly
          ? "border-purple-500/45 bg-purple-950/30 text-purple-200 hover:border-purple-400/60"
        : dep.isUsed
          ? "border-emerald-500/45 bg-emerald-950/30 text-emerald-200 hover:border-emerald-400/60"
          : "border-stone-900/70 bg-stone-950/60 text-stone-200 hover:border-stone-700";
      const glyphs = [];
      if (!dep.isDeclared) glyphs.push(Icon.alert("h-3 w-3"));
      if (dep.isToolingOnly) {
        glyphs.push(Icon.tool("h-3 w-3"));
      } else if (dep.isTypeOnly) {
        glyphs.push(Icon.type("h-3 w-3"));
      } else {
        glyphs.push(Icon.external("h-3 w-3"));
      }
      if (dep.isDevOnly) glyphs.push(Icon.dev("h-3 w-3"));
      return html`
        <span
          class=${`inline-flex flex-wrap items-center gap-2 rounded-md border px-3 py-1 text-xs font-medium transition ${tone}`}
        >
          <span class="flex items-center gap-1 text-current">
            ${glyphs.map(
              (icon, index) =>
                html`<span key=${index} class="inline-flex items-center justify-center">${icon}</span>`,
            )}
          </span>
          <span class="font-mono text-[11px]">${dep.name}</span>
          ${dep.isUsed && dep.usageCount > 0
            ? html`<span class="text-[10px] text-stone-300">x${dep.usageCount}</span>`
            : null}
        </span>
      `;
    };


    const PackageCard = ({ pkg }) => {
      const severityStyle = severityStyles[pkg.severityLevel] ?? severityStyles.stable;
      return html`
        <article
          id=${pkg.anchorId}
          class="group relative rounded-lg border border-stone-900/70 bg-stone-950/75 p-6 shadow-[0_20px_40px_-32px_rgba(0,0,0,0.8)] transition hover:border-stone-700"
        >
          <header class="flex flex-col gap-3 lg:flex-row lg:items-start lg:justify-between">
            <div class="space-y-2">
              <h3 class="flex flex-wrap items-center gap-3 text-xl font-semibold text-stone-100">
                <span class="flex h-9 w-9 items-center justify-center rounded-md bg-stone-900/60 text-stone-200">
                  ${Icon.package("h-4.5 w-4.5")}
                </span>
                <span>${pkg.displayName}</span>
                ${pkg.isRoot
                  ? html`<span class="inline-flex items-center gap-1 rounded-full border border-emerald-500/40 bg-emerald-950/30 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-200">
                      ${Icon.check("h-3 w-3")}
                      Root
                    </span>`
                  : null}
                ${pkg.version
                  ? html`<span class="rounded-full border border-stone-800/70 bg-stone-950/60 px-3 py-0.5 text-xs font-medium text-stone-300">
                      v${pkg.version}
                    </span>`
                  : null}
              </h3>
              ${pkg.description?.trim()
                ? html`<p class="text-[11px] leading-relaxed text-stone-300">
                    ${pkg.description}
                  </p>`
                : html`<p class="text-[11px] italic text-stone-500">
                    No description provided in package.json.
                  </p>`}
              ${pkg.relativeDir ? html`<p class="font-mono text-xs text-stone-500">${pkg.relativeDir}</p>` : null}
              ${pkg.severitySignals.length
                ? html`<div class="mt-2 flex flex-wrap gap-2">
                    ${pkg.severitySignals.map(
                      (signal, index) => html`<span
                        key=${index}
                        class="rounded-full border border-stone-800/70 bg-stone-950/60 px-2 py-0.5 text-[10px] font-medium uppercase tracking-wide text-stone-300"
                      >
                        ${signal}
                      </span>`,
                    )}
                  </div>`
                : null}
            </div>
            <span
              class=${cx(
                "inline-flex items-center gap-2 rounded-full border px-3 py-1 text-[11px] font-semibold uppercase tracking-wide shadow-[0_1px_2px_rgba(0,0,0,0.45)]",
                severityStyle.badge,
              )}
            >
              <span class="flex h-6 w-6 items-center justify-center rounded-full bg-black/20">
                ${severityStyle.icon("h-3.5 w-3.5")}
              </span>
              ${pkg.severityLabel}
            </span>
          </header>
          <section class="mt-4">
            <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">Internal dependencies</h4>
            <div class="mt-2 flex flex-wrap gap-2">
              ${pkg.dependencyBadges.length
                ? pkg.dependencyBadges.map((dep, index) => html`<${DependencyBadge} key=${index} dep=${dep} />`)
                : html`<span class="rounded-md border border-stone-900/70 bg-stone-950/60 px-3 py-1 text-xs font-medium text-stone-400">
                    No internal dependencies
                  </span>`}
            </div>
          </section>
          <section class="mt-4">
            <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">External dependencies</h4>
            <div class="mt-2 flex flex-wrap gap-2.5">
              ${pkg.externalDependencyBadges.length
                ? pkg.externalDependencyBadges.map((dep, index) => html`<${ExternalBadge} key=${index} dep=${dep} />`)
                : html`<span class="rounded-md border border-stone-900/70 bg-stone-950/60 px-3 py-1 text-xs font-medium text-stone-400">
                    No external dependencies
                  </span>`}
            </div>
          </section>
          <${DependencyDrilldown} items=${pkg.dependencyDrilldown} />
          ${pkg.toolingDepsList.length
            ? html`<section class="mt-4">
                <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">Tooling detected</h4>
                <div class="mt-2 flex flex-wrap gap-2.5">
                  ${pkg.toolingDepsList.map(
                    (tool, index) => html`<span
                      key=${index}
                      class="rounded-full border border-stone-900/70 bg-stone-950/60 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-stone-300"
                    >
                      ${tool}
                    </span>`,
                  )}
                </div>
              </section>`
            : null}
        </article>
      `;
    };

    const PackageList = ({ packages }) => html`
      <div class="grid gap-5">
        ${packages.map((pkg) => html`<${PackageCard} key=${pkg.anchorId} pkg=${pkg} />`)}
      </div>
    `;

    const App = ({ data, status, liveMode }) => {
      const [filter, setFilter] = useState("all");
      const [search, setSearch] = useState("");

      const counts = useMemo(() => {
        const base = { all: data.packages.length, issues: 0, tooling: 0, critical: 0 };
        data.packages.forEach((pkg) => {
          if (pkg.hasIssues) base.issues += 1;
          if (pkg.severityLevel === "critical") base.critical += 1;
          if (pkg.toolingDepsList.length) base.tooling += 1;
        });
        return base;
      }, [data.packages]);

      const performance = useMemo(() => derivePerformanceInsights(data.packages), [data.packages]);

      useEffect(() => {
        const metrics = {
          packages: data.summary.packageCount ?? 0,
          edges: data.summary.dependencyCount ?? 0,
          externals: data.summary.runtimeExternalCount ?? 0,
          generatedAt: data.meta.generatedAt || "—",
          nodeVersion: data.meta.nodeVersion || "—",
        };

        document.querySelectorAll("[data-hero-metric]").forEach((node) => {
          const key = node.getAttribute("data-hero-metric");
          if (!key || metrics[key] === undefined) return;
          node.textContent = String(metrics[key]);
        });

        const exportBtn = document.querySelector('[data-action="export-json"]');
        const handleExport = () => {
          let formatted = rawPayload;
          try {
            formatted = JSON.stringify(JSON.parse(rawPayload), null, 2);
          } catch {
            // Keep raw payload if parsing fails
          }
          const blob = new Blob([formatted], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const link = document.createElement("a");
          link.href = url;
          link.download = `retracify-atlas-${Date.now()}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        };
        exportBtn?.addEventListener("click", handleExport);

        const scrollButtons = document.querySelectorAll('[data-scroll-to]');
        const handleScroll = (event) => {
          const target = event.currentTarget?.getAttribute?.("data-scroll-to");
          if (!target) return;
          const el = document.querySelector(target);
          if (el) {
            el.scrollIntoView({ behavior: "smooth", block: "start" });
          }
        };
        scrollButtons.forEach((btn) => btn.addEventListener("click", handleScroll));

        return () => {
          exportBtn?.removeEventListener("click", handleExport);
          scrollButtons.forEach((btn) => btn.removeEventListener("click", handleScroll));
        };
      }, [data.summary, data.meta]);

      const filteredPackages = useMemo(() => {
        const needle = search.trim().toLowerCase();
        return data.packages.filter((pkg) => {
          if (filter === "issues" && !pkg.hasIssues) return false;
          if (filter === "critical" && pkg.severityLevel !== "critical") return false;
          if (filter === "tooling" && pkg.toolingDepsList.length === 0) return false;
          if (needle && !pkg.displayName.toLowerCase().includes(needle)) return false;
          return true;
        });
      }, [data.packages, filter, search]);

      return html`
        <div class="space-y-12">
          ${liveMode ? html`<${LiveStatusToast} status=${status} />` : null}
          ${liveMode && status && typeof status.progress === "number"
            ? html`<div class="flex items-center justify-between gap-3 rounded-lg border border-sky-900/70 bg-sky-950/40 px-4 py-2 text-xs text-sky-100">
                <span class="flex items-center gap-2 font-semibold uppercase tracking-wide">
                  ${Icon.cycle("h-3.5 w-3.5 animate-spin")} ${status.message}
                </span>
                <span class="font-mono text-sky-200">${Math.round(status.progress)}%</span>
              </div>`
            : null}
          <section id="overview" class="scroll-mt-24 space-y-6">
            <${SummaryCards} summary=${data.summary} meta=${data.meta} />
            <${KeySignals} summary=${data.summary} />
          </section>

          <section id="insights" class="scroll-mt-24">
            <${CycleInsights} summary=${data.summary} insights=${data.insights?.cycles} />
          </section>

          <section id="performance" class="scroll-mt-24">
            <${PerformancePanel} data=${performance} />
          </section>

          <section class="grid gap-6 lg:grid-cols-2" id="reference">
            <div class="scroll-mt-24">
              <${Legend} />
            </div>
            <div id="risk-guide" class="scroll-mt-24">
              <${RiskGuide} />
            </div>
          </section>

          <section id="packages" class="scroll-mt-24 space-y-6">
            <div class="grid gap-4">
              <${FilterBar}
                filter=${filter}
                setFilter=${setFilter}
                search=${search}
                setSearch=${setSearch}
                counts=${counts}
              />
            </div>
            ${filteredPackages.length === 0
              ? html`<div class="rounded-lg border border-stone-900/70 bg-stone-950/70 p-6 text-center text-sm text-stone-400">
                  No packages match the current filters.
                </div>`
              : html`<${PackageList} packages=${filteredPackages} />`}
          </section>
        </div>
      `;
    };

    const root = document.getElementById("app-root");
    if (root) {
      const renderApp = () => {
        render(html`<${App} data=${payload} status=${liveStatus} liveMode=${liveModeActive} />`, root);
      };

      root.innerHTML = "";
      renderApp();

      if (liveModeActive) {
        const connectStream = () => {
          const source = new EventSource("/events", { withCredentials: false });
          source.onmessage = (event) => {
            try {
              const nextRaw = event.data || "{}";
              const message = JSON.parse(nextRaw);
              if (message?.type === "report" && message.payload) {
                rawPayload = JSON.stringify(message.payload);
                payload = mergePayload(message.payload);
                if (message.meta) {
                  liveStatus = message.meta;
                }
                renderApp();
              } else if (message?.type === "progress" && message.status) {
                liveStatus = message.status;
                renderApp();
              }
            } catch (err) {
              console.error("Failed to handle live update", err);
            }
          };
          source.onerror = () => {
            source.close();
            setTimeout(connectStream, 2000);
          };
        };
        connectStream();
      }
    }
  </script>
</body>
</html>
