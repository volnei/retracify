<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dependency Report</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15' stop-opacity='0.85'/%3E%3Cstop offset='100%25' stop-color='%231c1917'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%230f172a' stroke='%23facc15' stroke-width='3' opacity='0.95'/%3E%3Ccircle cx='18' cy='22' r='5' fill='%2338bdf8' opacity='0.85'/%3E%3Ccircle cx='46' cy='18' r='4' fill='%23f97316' opacity='0.75'/%3E%3Cpath d='M20 44 C 26 38 38 38 44 44' stroke='%2338bdf8' fill='none' stroke-width='3' stroke-linecap='round' opacity='0.8'/%3E%3Ctext x='15' y='38' font-family='JetBrains Mono,Menlo,monospace' font-size='18' font-weight='700' fill='%23facc15'%3ER%3C/text%3E%3Ctext x='35' y='38' font-family='JetBrains Mono,Menlo,monospace' font-size='18' font-weight='700' fill='%23facc15'%3ET%3C/text%3E%3C/svg%3E" />
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23facc15' stop-opacity='0.85'/%3E%3Cstop offset='100%25' stop-color='%231c1917'/%3E%3C/linearGradient%3E%3C/defs%3E%3Ccircle cx='32' cy='32' r='30' fill='%230f172a' stroke='%23facc15' stroke-width='3' opacity='0.95'/%3E%3Ccircle cx='18' cy='22' r='5' fill='%2338bdf8' opacity='0.85'/%3E%3Ccircle cx='46' cy='18' r='4' fill='%23f97316' opacity='0.75'/%3E%3Cpath d='M20 44 C 26 38 38 38 44 44' stroke='%2338bdf8' fill='none' stroke-width='3' stroke-linecap='round' opacity='0.8'/%3E%3Ctext x='15' y='38' font-family='JetBrains Mono,Menlo,monospace' font-size='18' font-weight='700' fill='%23facc15'%3ER%3C/text%3E%3Ctext x='35' y='38' font-family='JetBrains Mono,Menlo,monospace' font-size='18' font-weight='700' fill='%23facc15'%3ET%3C/text%3E%3C/svg%3E" />
<script>
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ["Inter", "system-ui", "sans-serif"],
          mono: ["JetBrains Mono", "Menlo", "monospace"],
        },
        boxShadow: {
          surface: "0 22px 48px -28px rgba(8, 15, 28, 0.85)",
        },
      },
    },
  };
</script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
<style>
  :root { color-scheme: dark; }
  body { font-family: 'Inter', sans-serif; position: relative; }
  html { scroll-behavior: smooth; }
  a.no-underline:hover { text-decoration: none !important; }
  .github-corner svg { fill: #151513; color: #ffffff; }
  .github-corner svg .octo-arm { transform-origin: 130px 106px; }
  .github-corner:hover .octo-arm { animation: octocat-wave 560ms ease-in-out; }
  .github-corner:focus-visible { outline: 2px solid rgba(248, 250, 252, 0.9); outline-offset: 4px; }
  @keyframes octocat-wave {
    0%, 100% { transform: rotate(0); }
    20%, 60% { transform: rotate(-20deg); }
    40%, 80% { transform: rotate(10deg); }
  }
</style>
</head>
<body class="min-h-screen bg-slate-950 bg-[radial-gradient(circle_at_top,_rgba(56,189,248,0.08),_transparent_60%)] text-stone-200 antialiased">
  <a href="https://github.com/volnei/retracify" class="github-corner absolute right-0 top-0 z-40" aria-label="View source on GitHub" target="_blank" rel="noreferrer">
    <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 250 250" fill="#151513" style="position: absolute; top: 0; right: 0">
    <path d="M0 0l115 115h15l12 27 108 108V0z" fill="#fff"/>
    <path class="octo-arm" d="M128 109c-15-9-9-19-9-19 3-7 2-11 2-11-1-7 3-2 3-2 4 5 2 11 2 11-3 10 5 15 9 16" style="-webkit-transform-origin: 130px 106px; transform-origin: 130px 106px"/>
    <path class="octo-body" d="M115 115s4 2 5 0l14-14c3-2 6-3 8-3-8-11-15-24 2-41 5-5 10-7 16-7 1-2 3-7 12-11 0 0 5 3 7 16 4 2 8 5 12 9s7 8 9 12c14 3 17 7 17 7-4 8-9 11-11 11 0 6-2 11-7 16-16 16-30 10-41 2 0 3-1 7-5 11l-12 11c-1 1 1 5 1 5z"/>
    </svg>
  </a>
  <main class="relative mx-auto flex max-w-6xl flex-col gap-10 px-6 py-12">
    <div class="rounded-md bg-stone-950/70 p-8 shadow-surface backdrop-blur-lg sm:p-10 md:p-12">
      <div class="space-y-10">
        <%- include('partials/banner') %>
        <%- include('partials/legend') %>
        <div id="app-root" class="space-y-8">
          <div class="flex w-full justify-center py-16">
            <div class="flex flex-col items-center gap-3 text-sm text-stone-400">
          <div class="h-10 w-10 animate-spin rounded-full border-2 border-sky-400/60 border-t-transparent"></div>
              <p>Loading interactive overview…</p>
            </div>
          </div>
        </div>
        <%- include('partials/footer') %>
      </div>
    </div>
  </main>
  <button id="scrollTop" type="button" aria-label="Scroll to top" class="fixed bottom-8 right-8 z-40 hidden h-12 w-12 items-center justify-center rounded-full border border-stone-700/60 bg-stone-950/75 text-lg text-stone-300 shadow-[0_16px_32px_-20px_rgba(15,23,42,0.85)] transition hover:-translate-y-1 hover:bg-stone-900/70 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-stone-500">
    ⬆
  </button>
  <script>
    const starsBadge = document.getElementById("githubStars");
    if (starsBadge) {
      fetch("https://api.github.com/repos/volnei/retracify", { headers: { "Accept": "application/vnd.github+json" } })
        .then((response) => (response.ok ? response.json() : null))
        .then((data) => {
          if (!data || typeof data.stargazers_count !== "number") {
            throw new Error("No star data");
          }
          const count = data.stargazers_count;
        starsBadge.innerHTML = `<span class="text-sky-300">★</span><span class="uppercase tracking-[0.2em] text-stone-300">${count.toLocaleString()} stars</span>`;
        })
        .catch(() => {
        starsBadge.innerHTML = `<span class="text-sky-300">★</span><span class="uppercase tracking-[0.2em] text-stone-300">on github</span>`;
        });
    }

    const scrollTopBtn = document.getElementById("scrollTop");
    if (scrollTopBtn) {
      const toggleScrollTop = () => {
        scrollTopBtn.classList.toggle("hidden", window.scrollY < 320);
      };
      toggleScrollTop();
      window.addEventListener("scroll", toggleScrollTop, { passive: true });
      scrollTopBtn.addEventListener("click", () => {
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
    }
  </script>
  <script id="reportData" type="application/json"><%- clientPayload %></script>
  <script type="module">
    import { h, render } from "https://esm.sh/preact@10.19.3";
    import { html } from "https://esm.sh/htm@3.1.1/preact";
    import { useMemo, useState } from "https://esm.sh/preact@10.19.3/hooks";
    const cx = (...classes) => classes.filter(Boolean).join(" ");

    const payloadEl = document.getElementById("reportData");
    const fallbackPayload = {
      summary: {
        packageCount: 0,
        dependencyCount: 0,
        cyclicDependencyCount: 0,
        undeclaredDependencyCount: 0,
        runtimeExternalCount: 0,
        toolingExternalCount: 0,
        typeExternalCount: 0,
        toolingDependencyCount: 0,
        packagesWithIssues: 0,
        averageDependencyCount: 0,
        averageToolingDeps: 0,
      },
      packages: [],
      meta: {
        rootDir: "",
        generatedAt: "",
        nodeVersion: "",
        systemInfo: "",
      },
    };

    let parsedPayload = fallbackPayload;
    if (payloadEl) {
      try {
        parsedPayload = JSON.parse(payloadEl.textContent || "{}") || fallbackPayload;
      } catch (error) {
        console.error("Failed to parse report payload", error);
      }
    }

    const payload = {
      summary: { ...fallbackPayload.summary, ...(parsedPayload.summary || {}) },
      packages: Array.isArray(parsedPayload.packages) ? parsedPayload.packages : [],
      meta: { ...fallbackPayload.meta, ...(parsedPayload.meta || {}) },
    };

    const buttonBase = "flex w-full items-center justify-center rounded-lg px-4 py-2.5 text-sm font-medium transition-colors sm:w-auto sm:px-5 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-sky-300/60";

    const SummaryCards = ({ summary, meta }) => html`
      <section class="space-y-4">
        <div class="flex flex-col gap-4 rounded-md bg-stone-900/65 p-5 md:flex-row md:items-center md:justify-between">
          <div class="space-y-1">
            <h2 class="text-lg font-semibold text-stone-100">Explore the report</h2>
            <p class="text-sm text-stone-400">Inspect each workspace, filter by health, and map their relationships.</p>
          </div>
          <div class="flex flex-col text-right font-mono text-xs uppercase tracking-[0.25em] text-stone-500">
            <span>Generated <span class="text-stone-100">${meta.generatedAt}</span></span>
            <span>Runtime <span class="text-stone-100">${meta.nodeVersion}</span></span>
            <span>Host <span class="text-stone-100">${meta.systemInfo}</span></span>
          </div>
        </div>
        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-4">
          <div class="space-y-1 rounded-md border border-stone-800/60 bg-stone-950/60 p-4">
            <p class="text-xs font-semibold uppercase tracking-wide text-stone-400">Packages</p>
            <p class="text-lg font-semibold text-stone-100">
              ${summary.packageCount}
              <span class="text-sm font-medium text-sky-300/80">• ${summary.packagesWithIssues} need attention</span>
            </p>
            <p class="text-xs text-stone-500">Root directory: <span class="text-stone-200">${meta.rootDir}</span></p>
          </div>
          <div class="space-y-1 rounded-md border border-stone-800/60 bg-stone-950/60 p-4">
            <p class="text-xs font-semibold uppercase tracking-wide text-stone-400">Internal dependencies</p>
            <p class="text-lg font-semibold text-stone-100">
              ${summary.dependencyCount}
              <span class="text-sm font-medium text-stone-400">avg ${summary.averageDependencyCount}</span>
            </p>
            <p class="text-xs text-stone-500">Cyclic edges: <span class="text-stone-200">${summary.cyclicDependencyCount}</span></p>
          </div>
          <div class="space-y-1 rounded-md border border-stone-800/60 bg-stone-950/60 p-4">
            <p class="text-xs font-semibold uppercase tracking-wide text-stone-400">External footprint</p>
            <p class="text-lg font-semibold text-stone-100">${summary.runtimeExternalCount}</p>
            <p class="text-xs text-stone-500">Type-only:${" "}<span class="text-purple-200">${summary.typeExternalCount}</span></p>
          </div>
          <div class="space-y-1 rounded-md border border-stone-800/60 bg-stone-950/60 p-4">
            <p class="text-xs font-semibold uppercase tracking-wide text-stone-400">Tooling footprint</p>
            <p class="text-lg font-semibold text-stone-100">${summary.toolingExternalCount}
              <span class="text-sm font-medium text-stone-400">tool deps</span>
            </p>
            <p class="text-xs text-stone-500">Configs/scripts:<span class="text-stone-200"> ${summary.toolingDependencyCount}</span> • avg ${summary.averageToolingDeps}</p>
          </div>
        </div>
      </section>
    `;

    const ViewToggle = ({ view, onChange }) => html`
      <div class="flex flex-col items-stretch gap-2 rounded-xl border border-stone-800/60 bg-stone-950/80 p-2 sm:inline-flex sm:flex-row sm:items-center sm:gap-3">
        <button
          type="button"
          class=${cx(buttonBase, view === "list" ? "bg-sky-500/15 text-sky-100" : "bg-stone-900/70 text-stone-400 hover:text-stone-200")}
          aria-pressed=${view === "list"}
          onClick=${() => onChange("list")}
        >List View</button>
        <button
          type="button"
          class=${cx(buttonBase, view === "blocks" ? "bg-sky-500/15 text-sky-100" : "bg-stone-900/70 text-stone-400 hover:text-stone-200")}
          aria-pressed=${view === "blocks"}
          onClick=${() => onChange("blocks")}
        >Blocks View</button>
      </div>
    `;

    const filterOptions = [
      { id: "all", label: "All packages", accent: "bg-stone-800/60 text-stone-300" },
      { id: "issues", label: "Needs attention", accent: "bg-rose-500/15 text-rose-200" },
      { id: "tooling", label: "Has tooling", accent: "bg-sky-500/15 text-sky-200" },
    ];

    const FilterBar = ({ filter, setFilter, search, setSearch, counts }) => html`
      <div class="flex flex-col gap-4 rounded-xl border border-stone-800/60 bg-stone-950/80 p-3 sm:p-4">
        <div class="grid gap-3 sm:grid-cols-3">
          ${filterOptions.map(({ id, label, accent }) => {
            const isActive = filter === id;
            return html`
              <button
                key=${id}
                type="button"
                class=${cx(
                  "flex w-full flex-col items-start gap-1 rounded-xl border px-4 py-3 text-left transition",
                  isActive
                    ? "border-sky-400/70 bg-sky-500/10 text-sky-100"
                    : "border-stone-800/60 bg-stone-900/70 text-stone-300 hover:border-sky-300/40 hover:text-stone-100"
                )}
                onClick=${() => setFilter(id)}
              >
                <span class=${cx(
                  "inline-flex items-center gap-2 rounded-full px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide",
                  isActive ? "bg-sky-500/20 text-sky-100" : accent
                )}>${label}</span>
                <span class="text-lg font-semibold text-stone-100">${counts[id] ?? 0}</span>
                <span class="text-xs text-stone-500">${id === "all" ? "Total packages" : id === "issues" ? "Missing deps or unused externals" : "Configs or scripts detected"}</span>
              </button>`;
          })}
        </div>
        <label class="flex w-full items-center gap-3 rounded-full border border-stone-800/60 bg-stone-900/70 px-4 py-2 text-xs text-stone-400">
          <span class="text-stone-500">🔍</span>
          <input
            class="flex-1 bg-transparent text-sm text-stone-100 outline-none placeholder:text-stone-500"
            placeholder="Search packages"
            value=${search}
            onInput=${(event) => setSearch(event.currentTarget.value)}
          />
          ${search
            ? html`<button type="button" class="text-stone-500 hover:text-stone-200" onClick=${() => setSearch("")}>✕</button>`
            : null}
        </label>
      </div>
    `;

    const DependencyBadge = ({ dep }) => {
      const tones = dep.isUndeclared
        ? "bg-stone-950/70 text-stone-200 hover:bg-stone-900/65"
        : dep.isCyclic
          ? "bg-stone-950/70 text-stone-200 hover:bg-stone-900/65"
          : "bg-stone-950/60 text-stone-300 hover:bg-stone-900/60";
      const accents = [];
      if (dep.isCyclic) accents.push("bg-red-500");
      if (dep.isUndeclared) accents.push("bg-orange-500");
      return html`
        <a href=${`#${dep.anchor}`}
          class=${`inline-flex items-center gap-2 rounded-sm px-3 py-1 text-xs font-medium transition-colors ${tones}`}>
          ${accents.length
            ? html`<span class="flex items-center gap-1">${accents.map((accent, index) => html`<span key=${index} class="h-2 w-2 rounded-sm ${accent}"></span>`)}</span>`
            : null}
          <span class="font-mono text-[11px]">${dep.name}</span>
        </a>`;
    };

    const ExternalBadge = ({ dep }) => {
      const tone = !dep.isDeclared
        ? "bg-orange-500/20 text-orange-100 hover:bg-orange-500/30"
        : dep.isUsed
          ? dep.isToolingOnly
            ? "bg-blue-500/20 text-blue-100 hover:bg-blue-500/30"
            : "bg-emerald-500/15 text-emerald-200 hover:bg-emerald-500/25"
          : dep.isTypeOnly
            ? "bg-purple-500/20 text-purple-100 hover:bg-purple-500/30"
            : "bg-stone-950/60 text-stone-300 hover:bg-stone-900/60";
      return html`
        <span class=${`inline-flex items-center gap-2 rounded-sm px-3 py-1 text-xs font-medium transition-colors ${tone}`}>
          <span class="font-mono text-[11px]">${dep.name}</span>
          <span class="rounded-sm bg-stone-950/40 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-stone-200/90">${dep.statusLabel}</span>
          ${dep.isTypeOnly
            ? html`<span class="rounded-sm bg-purple-500/30 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-purple-50">Type</span>`
            : null}
          ${dep.isToolingOnly
            ? html`<span class="rounded-sm bg-blue-500/25 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-blue-50">Tool</span>`
            : null}
          ${dep.isUsed && dep.usageCount > 0
            ? html`<span class="text-[10px] text-stone-400">x${dep.usageCount}</span>`
            : null}
        </span>`;
    };

    const PackageCard = ({ pkg }) => html`
      <article
        id=${pkg.anchorId}
        class="group relative rounded-md border border-stone-800/60 bg-stone-900/75 p-6 shadow-sm shadow-black/40 transition">
        ${pkg.hasIssues
          ? html`<span class="pointer-events-none absolute right-0 top-0 h-0 w-0 border-l-[32px] border-t-[32px] border-l-transparent border-t-red-500/80 opacity-85"></span>`
          : null}
        <header class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
          <div class="space-y-1">
            <h3 class="flex items-center gap-2 text-xl font-semibold text-stone-100">
              <span class="text-stone-300">📦</span>
              <span>${pkg.displayName}</span>
              ${pkg.isRoot
                ? html`<span class="rounded-sm bg-emerald-500/20 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-300">Root</span>`
                : null}
              ${pkg.version
                ? html`<span class="rounded-sm bg-stone-900/60 px-3 py-0.5 text-xs font-medium text-stone-300">v${pkg.version}</span>`
                : null}
            </h3>
            ${pkg.description
              ? html`<p class="max-w-[32ch] text-[11px] text-stone-400/90 line-clamp-2">${pkg.description}</p>`
              : null}
            ${pkg.relativeDir
              ? html`<p class="font-mono text-xs text-stone-500">${pkg.relativeDir}</p>`
              : null}
          </div>
          <dl class="grid grid-cols-2 gap-3 text-xs text-stone-400 sm:text-sm md:text-right">
            <div>
              <dt class="uppercase tracking-wide text-stone-500">Files</dt>
              <dd class="font-semibold text-stone-200">${pkg.fileCount ?? 0}</dd>
            </div>
            <div>
              <dt class="uppercase tracking-wide text-stone-500">Dependencies</dt>
              <dd class="font-semibold text-stone-200">${pkg.dependencies.length}</dd>
            </div>
            <div>
              <dt class="uppercase tracking-wide text-stone-500">References</dt>
              <dd class="font-semibold text-stone-200">${pkg.references}</dd>
            </div>
            <div>
              <dt class="uppercase tracking-wide text-stone-500">External</dt>
              <dd class="font-semibold text-stone-200">${pkg.runtimeExternalCount}</dd>
            </div>
          </dl>
        </header>
        <section class="mt-4">
          <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">Dependencies</h4>
          <div class="mt-2 flex flex-wrap gap-2.5">
            ${pkg.dependencyBadges.length
              ? pkg.dependencyBadges.map((dep, index) => html`<${DependencyBadge} key=${index} dep=${dep} />`)
              : html`<span class="rounded-sm bg-stone-900/60 px-3 py-1 text-xs font-medium text-stone-400">No internal dependencies</span>`}
          </div>
        </section>
        <section class="mt-4">
          <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">External Dependencies</h4>
          <div class="mt-2 flex flex-wrap gap-2.5">
            ${pkg.externalDependencyBadges.length
              ? pkg.externalDependencyBadges.map((dep, index) => html`<${ExternalBadge} key=${index} dep=${dep} />`)
              : html`<span class="rounded-sm bg-stone-900/60 px-3 py-1 text-xs font-medium text-stone-400">No external dependencies</span>`}
          </div>
        </section>
        ${pkg.toolingDepsList.length
          ? html`<section class="mt-4">
              <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">Tooling detected</h4>
              <div class="mt-2 flex flex-wrap gap-2.5">
                ${pkg.toolingDepsList.map((tool, index) => html`<span key=${index} class="rounded-sm bg-blue-500/15 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-blue-100">${tool}</span>`)}
              </div>
            </section>`
          : null}
      </article>
    `;

    const PackageList = ({ packages }) => html`
      <div class="grid gap-5">
        ${packages.map((pkg) => html`<${PackageCard} key=${pkg.anchorId} pkg=${pkg} />`)}
      </div>
    `;

    const BlocksView = ({ packages }) => {
      const [hovered, setHovered] = useState(null);
      const [selected, setSelected] = useState(null);
      const dependentsByName = useMemo(() => {
        const map = new Map();
        packages.forEach((pkg) => {
          (pkg.dependencyBadges || []).forEach((dep) => {
            if (!map.has(dep.name)) map.set(dep.name, new Set());
            map.get(dep.name).add(pkg.anchorId);
          });
        });
        return map;
      }, [packages]);

      const focusKey = selected ?? hovered;
      const focusPackage = focusKey ? packages.find((pkg) => pkg.name === focusKey) : null;

      const activeDependents = focusKey ? dependentsByName.get(focusKey) || new Set() : new Set();

      const handleToggleSelect = (pkgName) => {
        setSelected((current) => (current === pkgName ? null : pkgName));
      };

      const handleKeyToggle = (event, pkgName) => {
        if (event.key === "Enter" || event.key === " ") {
          event.preventDefault();
          handleToggleSelect(pkgName);
        }
      };

      return html`
        <section class="rounded-md bg-stone-900/75 p-5 shadow-sm shadow-black/40">
          <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
            <h2 class="text-sm font-semibold uppercase tracking-wide text-stone-400">Dependency Blocks</h2>
            <p class="text-xs text-stone-500">Hover to preview dependents or click to lock a selection. Click again to clear.</p>
          </div>
          <div class="mt-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5">
            ${packages.map((pkg) => {
              const dependentsCount = dependentsByName.get(pkg.name)?.size ?? 0;
              const isSelected = selected === pkg.name;
              const isHovered = !isSelected && hovered === pkg.name;
              const isDependent = Boolean(focusKey) && activeDependents.has(pkg.anchorId);
              const baseClass = "block-card relative flex min-h-[88px] flex-col justify-between gap-4 rounded-lg border border-stone-800/60 bg-stone-950/70 px-4 py-3 shadow-sm shadow-black/30 transition duration-150 sm:min-h-[96px] sm:px-5 sm:py-4";
              const highlightClass = isSelected
                ? "ring-2 ring-sky-300/70 bg-stone-900/55"
                : isDependent
                  ? "ring-2 ring-rose-400/70 bg-stone-900/60"
                  : isHovered
                    ? "ring-1 ring-stone-700/60 bg-stone-900/60"
                    : "hover:-translate-y-0.5 hover:bg-stone-900/65";
              return html`
                <article
                  key=${pkg.anchorId}
                  class=${`${baseClass} ${highlightClass}`}
                  tabindex="0"
                  onMouseEnter=${() => setHovered(pkg.name)}
                  onFocus=${() => setHovered(pkg.name)}
                  onMouseLeave=${() => setHovered(null)}
                  onBlur=${() => setHovered(null)}
                  onClick=${() => handleToggleSelect(pkg.name)}
                  onKeyDown=${(event) => handleKeyToggle(event, pkg.name)}
                >
                  <div class="flex items-start justify-between gap-2">
                    <h3 class="line-clamp-2 text-sm font-medium leading-tight text-stone-100">${pkg.displayName}</h3>
                    ${pkg.isRoot
                      ? html`<span class="shrink-0 rounded-sm bg-emerald-500/20 px-2 py-0.5 text-[9px] font-semibold uppercase tracking-wide text-emerald-300">Root</span>`
                      : null}
                  </div>
                  <div class="flex items-center gap-2 text-xs text-stone-400">
                    ${pkg.undeclaredDeps.length
                      ? html`<span class="inline-flex h-2 w-2 rounded-full bg-orange-500"></span>`
                      : null}
                    ${pkg.cyclicCount > 0
                      ? html`<span class="inline-flex h-2 w-2 rounded-full bg-red-500"></span>`
                      : null}
                    ${dependentsCount
                      ? html`<span class="rounded-sm bg-stone-900/70 px-2 py-0.5 text-[10px] font-semibold text-stone-300">${dependentsCount}</span>`
                      : null}
                  </div>
                  <div class="flex flex-wrap items-center gap-2 text-[11px] text-stone-400">
                    <span class="rounded-sm bg-stone-900/70 px-2 py-0.5 font-mono text-[10px] text-stone-300">
                      ${pkg.dependencies.length} deps
                    </span>
                    <span class="rounded-sm bg-stone-900/70 px-2 py-0.5 font-mono text-[10px] text-stone-300">
                      ${dependentsCount} dependents
                    </span>
                    ${pkg.externalDependencyBadges.length
                      ? html`<span class="rounded-sm bg-blue-500/15 px-2 py-0.5 font-mono text-[10px] text-blue-100">
                          ${pkg.externalDependencyBadges.length} external
                        </span>`
                      : null}
                    ${pkg.undeclaredDeps.length
                      ? html`<span class="rounded-sm bg-orange-500/20 px-2 py-0.5 font-mono text-[10px] text-orange-100">
                          ${pkg.undeclaredDeps.length} undeclared
                        </span>`
                      : null}
                    ${pkg.cyclicCount > 0
                      ? html`<span class="rounded-sm bg-red-500/20 px-2 py-0.5 font-mono text-[10px] text-red-100">
                          ${pkg.cyclicCount} cyclic
                        </span>`
                      : null}
                  </div>
                </article>`;
            })}
          </div>
          ${focusPackage
            ? html`<div class="mt-6 rounded-lg border border-stone-800/60 bg-stone-950/80 p-5">
                <div class="flex flex-col gap-2 sm:flex-row sm:items-baseline sm:justify-between">
                  <div>
                    <p class="text-xs uppercase tracking-wide text-stone-500">Selected package</p>
                    <h3 class="text-lg font-semibold text-stone-100">${focusPackage.displayName}</h3>
                    ${focusPackage.relativeDir
                      ? html`<p class="font-mono text-xs text-stone-500">${focusPackage.relativeDir}</p>`
                      : null}
                  </div>
                  <button
                    type="button"
                    class="self-start rounded-md border border-stone-800/60 px-3 py-1.5 text-xs font-medium text-stone-300 transition hover:border-stone-600 hover:text-sky-200 sm:self-auto"
                    onClick=${() => setSelected(null)}
                  >
                    Clear selection
                  </button>
                </div>
                <div class="mt-4 grid gap-4 md:grid-cols-2">
                  <div>
                    <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">
                      Internal dependencies (${focusPackage.dependencies.length})
                    </h4>
                    <div class="mt-2 flex flex-wrap gap-2">
                      ${focusPackage.dependencyBadges.length
                        ? focusPackage.dependencyBadges.map((dep, index) =>
                            html`<span
                              key=${index}
                              class="rounded-sm bg-stone-900/70 px-3 py-1 text-xs font-medium text-stone-200"
                            >
                              ${dep.name}
                            </span>`,
                          )
                        : html`<span class="rounded-sm bg-stone-900/60 px-3 py-1 text-xs text-stone-400">
                            No internal dependencies
                          </span>`}
                    </div>
                  </div>
                  <div>
                    <h4 class="text-xs font-semibold uppercase tracking-wide text-stone-500">
                      External footprint (${focusPackage.externalDependencyBadges.length})
                    </h4>
                    <div class="mt-2 flex flex-wrap gap-2">
                      ${focusPackage.externalDependencyBadges.length
                        ? focusPackage.externalDependencyBadges.map((dep, index) =>
                            html`<span
                              key=${index}
                              class="rounded-sm bg-blue-500/15 px-3 py-1 text-xs font-medium text-blue-100"
                            >
                              ${dep.name}
                            </span>`,
                          )
                        : html`<span class="rounded-sm bg-stone-900/60 px-3 py-1 text-xs text-stone-400">
                            No external dependencies
                          </span>`}
                    </div>
                  </div>
                </div>
              </div>`
            : null}
        </section>
      `;
    };

    const App = ({ data }) => {
      const [view, setView] = useState("list");
      const [filter, setFilter] = useState("all");
      const [search, setSearch] = useState("");

      const counts = useMemo(() => {
        const base = { all: data.packages.length, issues: 0, tooling: 0 };
        data.packages.forEach((pkg) => {
          if (pkg.hasIssues) base.issues += 1;
          if (pkg.toolingDepsList.length) base.tooling += 1;
        });
        return base;
      }, [data.packages]);

      const filteredPackages = useMemo(() => {
        const needle = search.trim().toLowerCase();
        return data.packages.filter((pkg) => {
          if (filter === "issues" && !pkg.hasIssues) return false;
          if (filter === "tooling" && pkg.toolingDepsList.length === 0) return false;
          if (needle && !pkg.displayName.toLowerCase().includes(needle)) return false;
          return true;
        });
      }, [data.packages, filter, search]);

      return html`
        <div class="space-y-6">
          <${SummaryCards} summary=${data.summary} meta=${data.meta} />
          <div class="grid gap-4 lg:grid-cols-[auto,1fr]">
            <${ViewToggle} view=${view} onChange=${setView} />
            <${FilterBar}
              filter=${filter}
              setFilter=${setFilter}
              search=${search}
              setSearch=${setSearch}
              counts=${counts}
            />
          </div>
          ${filteredPackages.length === 0
            ? html`<div class="rounded-md border border-stone-800/60 bg-stone-950/70 p-6 text-center text-sm text-stone-400">No packages match the current filters.</div>`
            : view === "list"
              ? html`<${PackageList} packages=${filteredPackages} />`
              : html`<${BlocksView} packages=${filteredPackages} />`}
        </div>
      `;
    };

    const root = document.getElementById("app-root");
    if (root) {
      root.innerHTML = "";
      render(html`<${App} data=${payload} />`, root);
    }
  </script>
</body>
</html>
